<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Run test.wasm</title>
  <!-- Load PixiJS -->
  <script src="https://cdn.jsdelivr.net/npm/pixi.js@8.0.0/dist/pixi.min.js"></script>
</head>
<body>
  <h1>Running test.wasm</h1>
  <script type="module">
    import { WASI } from "https://cdn.jsdelivr.net/gh/haskell-wasm/browser_wasi_shim@main/index.js";
    import ghc_wasm_jsffi from "./ghc_wasm_jsffi.js";

    // Make PIXI available globally for the WASM module
    window.PIXI = PIXI;
    window.Application = PIXI.Application;
    window.Sprite = PIXI.Sprite;
    window.Assets = PIXI.Assets;

    // Check for WebAssembly support
    if ("WebAssembly" in window) {
      const wasi = new WASI({
        stdout: (out) => console.log("[wasm stdout]", out),
        stderr: (out) => console.error("[wasm stderr]", out)
      });

      const jsffiExports = {};

      try {
        console.log('Creating JSFFI imports...');
        const jsffiImports = ghc_wasm_jsffi(jsffiExports);
        console.log('JSFFI imports created:', jsffiImports);

        console.log('Getting WASI import object...');
        const wasiImports = wasi.getImportObject();
        console.log('WASI imports:', Object.keys(wasiImports));

        const importObject = Object.assign(
          { ghc_wasm_jsffi: jsffiImports },
          wasiImports
        );
        console.log('Full import object:', Object.keys(importObject));

        console.log('Fetching and instantiating WASM...');
        const result = await WebAssembly.instantiateStreaming(
          fetch('./test.wasm'),
          importObject
        );

        console.log('WASM instantiated, result:', result);
        console.log('Instance:', result.instance);

        if (!result || !result.instance) {
          throw new Error('Failed to get instance from instantiateStreaming');
        }

        const instance = result.instance;
        console.log('Instance exports:', Object.keys(instance.exports));

        // Fill in the jsffiExports with the instance exports for FFI to work
        Object.assign(jsffiExports, instance.exports);
        console.log('JSFFI exports filled:', Object.keys(jsffiExports));

        // Initialize the reactor module (instead of start)
        // wasi.initialize expects the full result object, not just the instance
        console.log('Initializing WASI...');
        wasi.initialize(result, {
          ghc_wasm_jsffi: ghc_wasm_jsffi(jsffiExports)
        });
        console.log('WASI initialized');

        // Call the exported main function
        if (instance.exports.main) {
          console.log('Calling main...');
          instance.exports.main();
        } else {
          console.log('No main export found in test.wasm.');
          console.log('Available exports:', Object.keys(instance.exports));
        }
      } catch (error) {
        console.error('Error loading WASM:', error);
        console.error('Error stack:', error.stack);
        document.body.innerHTML += `<pre>Error loading WASM: ${error.message}\n${error.stack}</pre>`;
      }
    } else {
      document.body.innerHTML += "<pre>This browser does not support WebAssembly.</pre>";
    }
  </script>
</body>
</html>
